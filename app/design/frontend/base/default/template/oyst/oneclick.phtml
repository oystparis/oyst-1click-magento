<?php
/**
 * This file is part of Oyst_OneClick for Magento.
 *
 * @license http://www.apache.org/licenses/LICENSE-2.0 Apache License, Version 2.0
 * @author Oyst <plugin@oyst.com> <@oyst>
 * @category Oyst
 * @package Oyst_OneClick
 * @copyright Copyright (c) 2017 Oyst (http://www.oyst.com)
 */

/**
 * @var Oyst_OneClick_Block_OneClick $this
 */
?>
<?php
/** @var Mage_Catalog_Model_Product $product */
$product = $this->getProduct();

/** @var string $oneClickUrl */
$oneClickUrl = $this->getOneClickUrl();

/** @var Oyst_OneClick_Helper_Catalog_Data $catalogHelper */
$catalogHelper = Mage::helper('oyst_oneclick/catalog_data');

if ($catalogHelper->isSupportedProduct($product)) :
?>
    <div id="oyst-1click-button"></div>
    <script>
        function getSimpleProductId() {
            if (typeof(spConfig) == 'undefined') {
                return null;
            }

            var productCandidates = [];

            jQuery.each(spConfig.settings, function (selectIndex, select) {
                var attributeId = select.id.replace('attribute', '');
                var selectedValue = select.options[select.selectedIndex].value;

                jQuery.each(spConfig.config.attributes[attributeId].options, function (optionIndex, option) {
                    if (option.id == selectedValue) {
                        var optionProducts = option.products;

                        if (0 == productCandidates.length) {
                            productCandidates = optionProducts;
                        } else {
                            var productIntersection = [];
                            jQuery.each(optionProducts, function (productIndex, productId) {
                                if (-1 < productCandidates.indexOf(productId)) {
                                    productIntersection.push(productId);
                                }
                            });
                            productCandidates = productIntersection;
                        }
                    }
                });
            });

            return (1 == productCandidates.length) ? productCandidates[0] : null;
        }

        (function() {
            window.__OYST__ = window.__OYST__ || {};
            window.__OYST__.getOneClickURL = function (cb) {
                jQuery(function () {
                    var qty = $$("input[name='qty']")[0].value ? $$("input[name='qty']")[0].value : 1;

                    var form = new FormData();
                    form.append("productRef", <?php echo $product->getId(); ?>);
                    form.append("variationRef", getSimpleProductId());
                    form.append("quantity", qty);

                    var settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": "<?php echo $oneClickUrl ?>",
                        "method": "POST",
                        "headers": {
                            "cache-control": "no-cache"
                        },
                        "processData": false,
                        "contentType": false,
                        "mimeType": "multipart/form-data",
                        "data": form
                    };
                    var formValidation = productAddToCartForm.validator.validate() ?
                        null : productAddToCartForm.validator.validate();

                    jQuery.ajax(settings).done(function (data) {
                        data = JSON.parse(data);
                        cb(null, data.url);
                    });
                })
            };
        })();
    </script>
<?php endif; ?>
